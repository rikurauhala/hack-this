LINK: https://github.com/rikurauhala/hack-this  
Installation instructions can be found in the README.md file.

## FLAW 1: Injection (A1:2017)

https://github.com/rikurauhala/hack-this/blob/main/server/src/routes/login.ts#L14
https://github.com/rikurauhala/hack-this/blob/main/server/src/db/database.ts#L57
    
The login functionality contains an SQL injection vulnerability. This vulnerability is only possible because several horrible design choices have been made. Firstly, passwords are being stored in the database as plaintext which is already a huge mistake. Secondly, user input (username and password) is not being properly sanitized. The unsanitized input is then being directly inserted into the database query.

https://github.com/rikurauhala/hack-this/blob/fixed/server/data/init.sql#L7
https://github.com/rikurauhala/hack-this/blob/fixed/server/src/db/database.ts#L57
https://github.com/rikurauhala/hack-this/blob/fixed/server/src/routes/login.ts#L21

The first step to fix the vulnerability is to storing passwords as hashes in the database. Never store passwords as plaintext! Checking if the password is correct should be done by comparing only the hashes. The vulnerable SQL query can be taken care of by using parameterized queries for the login function. Modern frameworks and libraries are already making SQL injection more and more obsolete, but the developer still has to know what they are doing. Always use parameterized queries and never trust user input enough to allow it anywhere near the database without checking first.

## FLAW 2: Broken Authentication (A2:2017)

https://github.com/rikurauhala/hack-this/blob/main/server/data/init.sql#L35

The admin account uses a very weak password that can be easily guessed or brute forced. This is a huge security flaw as guessing or cracking the admin password can compromise the whole application and give the attacker access to every functionality on the site.

https://github.com/rikurauhala/hack-this/blob/fixed/server/data/init.sql#L38
https://github.com/rikurauhala/hack-this/blob/fixed/server/src/routes/login.ts#L12

The weak admin password can be fixed by using a random string of characters instead of using a simple six-letter word that can be easily cracked. The admin account name has also been changed for extra security as it makes it harder for the attacker to guess which account they should be targeting. The application contains no public list of administrators so the name of an account is the only thing that might give away administrator status.

As an additional security measure, rate limiting has been added to the login router. Now the API can no longer be spammed trying to guess any passwords by brute force.

To improve the security further, weak passwords should never be allowed in the first place. Users and especially administrators should not be allowed to use passwords that can be easily guessed and/or are found in the dictionary.

## FLAW 3: Broken Access Control (A5:2017)

https://github.com/rikurauhala/hack-this/blob/main/server/src/routes/messages.ts#L33

JSON Web Token (JWT) is used for authenticating users and checking if they have sufficient permissions to perform actions on the website. However, there is a problem: the developer of the application has intended the message deletion functionality to be available only for the admin account, but has forgotten to actually check the admin status before deleting the message. This means that anyone who is logged in and is in posession of a valid token can delete any message.

In the frontend the message deletion button is only visible for administrators but this doesn't stop anyone from simply making a DELETE request to the "/api/messages/<messageId>" endpoint and deleting any message they want. This demonstrates why it is extremely important to make sure the backend is secure. The frontend can be easily modified or bypassed.

https://github.com/rikurauhala/hack-this/blob/fixed/server/src/routes/messages.ts#L43

An easy fix is to simply verify that the user who made the request does actually have administrative permissions to delete the message. This is why the admin status is stored as a boolean and saved in the token.

## FLAW 4: Cross-Site Scripting (A7:2017)

https://github.com/rikurauhala/hack-this/blob/main/server/src/routes/messages.ts#L22
https://github.com/rikurauhala/hack-this/blob/main/web/src/components/GuestBook/GuestBookMessage/GuestBookMessageContent.tsx#L13

The application contains a critical stored cross-site scripting vulnerability. Users can leave messages in the guest book for other users to read. However, the messages are not sanitized at all before being inserted into the database. The vulnerability is made possible by another horrible mistake in the frontend. The frontend is made using the React.js library which by default has some safety measures in place to prevent XSS. However, the application uses the aptly named "dangerouslySetInnerHTML" property to allow unescaped input to be inserted into the DOM.

These two design mistakes allow users to enter JavaScript code via the guest book. This code will get stored in the database and is loaded when another user enters the guest book page. Taking advantage of for example the HTML <img> tags "onLoad" property, malicious code can be instantly executed when a victim loads the guest book page

https://github.com/rikurauhala/hack-this/blob/fixed/server/src/routes/messages.ts#L29
https://github.com/rikurauhala/hack-this/blob/fixed/web/src/components/GuestBook/GuestBookMessage/GuestBookMessageContent.tsx#L13

To fix the cross-site scripting vulnerability, messages are sanitized in the backend and the frontend no longer uses the dangerouslySetInnerHTML property.

## FLAW 5: Insufficient Logging & Monitoring (A10:2017)

https://github.com/rikurauhala/hack-this/blob/main/server/src/utils/middleware.ts#L71
https://github.com/rikurauhala/hack-this/blob/main/server/src/index.ts#L13

Middleware logging all requests to the server has been created but the developer has forgotten to turn actually use it. If all requests were properly being logged, the administrators could more easily detect any suspicious activity and take action if necessary.

https://github.com/rikurauhala/hack-this/blob/fixed/server/src/index.ts#L13

Fixing the logging issue is trivial. As the request logger middleware already exists, it can be easily turned on. The middleware logs all requests the server has received, their timestamp and the IP address the request originated from. For now the logs are written into a text file and require manual review but as the logging functionality already exists, it should be easy to extend it include more information.

For additional security, automatic alerts could be set up. Any suspicious activity would be reported to the administrator. For example, someone trying to repeatedly log in to an account should trigger an alarm.
